<!doctype html>
<meta charset="utf-8" />
<title>Push Subscribe</title>
<script>
const VAPID_PUBLIC_KEY = "BKDYl1tog8AGY9kq9b94ztIroWBw1smpQp5kGTh5-O1Apz3cFSQO_f7kes_ct7QTVtPSYQaaOZv83eV28kprzNk";
function urlB64ToUint8Array(s){const p="=".repeat((4-s.length%4)%4);const b=(s+p).replace(/-/g,"+").replace(/_/g,"/");const r=atob(b);const a=new Uint8Array(r.length);for(let i=0;i<r.length;i++)a[i]=r.charCodeAt(i);return a;}

(async () => {
  if (!("serviceWorker" in navigator) || !("PushManager" in window)) {
    document.body.textContent = "Web Push 非対応ブラウザです。"; return;
  }
  const reg = await navigator.serviceWorker.register("./sw.js", { scope: "./" });
  let perm = Notification.permission;
  if (perm !== "granted") perm = await Notification.requestPermission();
  if (perm !== "granted") { document.body.textContent = "通知が許可されませんでした。"; return; }

  let sub = await reg.pushManager.getSubscription();
  if (!sub) {
    sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: urlB64ToUint8Array(VAPID_PUBLIC_KEY) });
  }

  // ✅ 親(Gradio共有ページ)のオリジンへ返す
  let openerOrigin = "*";
  try { openerOrigin = new URL(document.referrer).origin; } catch(_) {}
  try { window.opener && window.opener.postMessage({ type: "PUSH_SUB", subscription: sub.toJSON() }, openerOrigin); } catch(_) {}

  document.body.innerHTML = "<p>通知が有効化されました。ウィンドウを閉じます…</p>";
  setTimeout(() => window.close(), 500);
})();
</script>